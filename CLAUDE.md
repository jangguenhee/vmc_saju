# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

---

## Project Overview

**365일 사주 (vcm-saju)** - AI-powered Korean fortune-telling (Saju) SaaS application with subscription billing.

**Core Value Proposition**: Users get 3 free AI fortune analyses, then subscribe (₩3,650/month) to receive daily personalized Saju reports generated by Gemini AI.

**Tech Stack**:
- **Frontend**: Next.js 16 (App Router), React 19, TailwindCSS 4
- **Authentication**: Clerk SDK (Google OAuth) + Supabase Auth
- **Database**: Supabase (PostgreSQL with RLS)
- **Payments**: TossPayments SDK (subscription billing)
- **AI**: Google Gemini API (`gemini-2.5-flash` for free, `gemini-2.5-pro` for paid)
- **API Framework**: Hono (lightweight web framework)
- **Deployment**: Vercel

---

## Common Commands

### Development
```bash
# Start dev server with Turbopack
npm run dev

# Build for production
npm run build

# Start production server
npm run start

# Run linter
npm run lint
```

### Environment Setup
Ensure `.env.local` contains:
```
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=
CLERK_SECRET_KEY=
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
TOSS_SECRET_KEY=
TOSS_CLIENT_KEY=
GEMINI_API_KEY=
```

---

## Architecture Overview

### API Layer: Hono-based Backend

All API routes are handled through a **single catch-all route** at `src/app/api/[[...hono]]/route.ts`:

```
Client Request → /api/* → Hono App → Feature Routes → Supabase/External APIs
```

**Key Files**:
- `src/backend/hono/app.ts` - Main Hono app with middleware registration
- `src/backend/hono/context.ts` - Type definitions for Hono context
- `src/backend/middleware/` - Shared middleware (error handling, Supabase, context)

**Middleware Stack** (applied to all routes):
1. `errorBoundary()` - Catches and formats errors
2. `withAppContext()` - Injects app-level context
3. `withSupabase()` - Provides Supabase client

**Adding New API Routes**:
1. Create feature folder: `src/features/{feature-name}/backend/`
2. Define route handler: `route.ts`
3. Register in `src/backend/hono/app.ts`:
   ```typescript
   import { registerExampleRoutes } from '@/features/example/backend/route';
   registerExampleRoutes(app);
   ```

### Feature-Based Organization

Code is organized by **features**, not layers:

```
src/features/{feature-name}/
├── backend/
│   ├── route.ts       # Hono route handlers
│   ├── service.ts     # Business logic
│   ├── schema.ts      # Zod validation schemas
│   └── error.ts       # Feature-specific errors
├── components/        # React components
├── hooks/            # React hooks (useQuery, etc.)
└── lib/              # Utilities, DTOs
```

**Example**: See `src/features/example/` for reference implementation.

### Authentication Architecture

**Dual Auth System**: Clerk (primary) + Supabase Auth (middleware only)

1. **Clerk**: Handles all user authentication (Google OAuth)
   - Webhook at `/api/webhooks/clerk` syncs users to Supabase `users` table
   - User ID is TEXT type (Clerk's user ID format)

2. **Supabase Auth**: Used only in `middleware.ts` for route protection
   - Checks authentication state
   - Redirects unauthenticated users to `/login`

**Protected Routes**:
- Defined in `src/constants/auth.ts`
- All routes except PUBLIC_PATHS and PUBLIC_PREFIXES require auth
- Middleware (`middleware.ts`) enforces protection

**IMPORTANT**: When querying Supabase from API routes, use **Service Role Key** (not anon key) because RLS policies are configured for service role access only.

### Database Layer

**Supabase Client Strategy**:
- `src/lib/supabase/server.ts` - Server-side client with Service Role Key
- `src/lib/supabase/browser-client.ts` - Client-side (if needed)
- `src/backend/supabase/client.ts` - Backend API client

**Tables** (see `docs/database.md` for full schema):
1. `users` - User accounts, subscription status, free trial tracking
2. `analysis` - AI-generated Saju analysis results
3. `payment_logs` - Payment transaction history

**RLS (Row Level Security)**:
- ALL tables use Service Role-only access
- Client never directly accesses Supabase
- Authorization logic is in Next.js API routes (validated via Clerk session)

**Sample Query Pattern**:
```typescript
import { auth } from '@clerk/nextjs';
import { createClient } from '@/lib/supabase/server';

export async function GET(req: Request) {
  const { userId } = auth();
  if (!userId) return new Response('Unauthorized', { status: 401 });

  const supabase = await createClient();
  const { data } = await supabase
    .from('users')
    .select('*')
    .eq('id', userId)  // Clerk userId
    .single();

  return Response.json(data);
}
```

### Subscription Flow

**User Journey**:
```
Sign up → 3 free analyses → Subscribe (₩3,650/month) → Daily AI reports
```

**Plan States**:
- `free` - Initial state, 3 free analyses (uses `gemini-2.5-flash`)
- `paid` - Active subscription (uses `gemini-2.5-pro`, daily reports)
- `cancelled` - Subscription cancelled, valid until next billing date
- `suspended` - Payment failed, service paused

**Payment Integration** (TossPayments):
- Billing key stored in `users.billing_key`
- Webhook handler at `/api/webhooks/toss` processes payment events
- Supabase Cron job checks `next_billing_date` daily for recurring billing
- Fail-safe: If webhook fails, cron job handles billing

---

## Key Patterns & Conventions

### Error Handling

**Backend Response Format** (`src/backend/http/response.ts`):
```typescript
import { failure, respond } from '@/backend/http/response';

// Return standardized error
return respond(c, failure(400, 'ERROR_CODE', 'User message', metadata));
```

**Service Layer**:
- Return `Result` type (either success or error)
- Error codes defined in `{feature}/backend/error.ts`

### Validation

**Use Zod schemas** for all input validation:
```typescript
import { z } from 'zod';

const MySchema = z.object({
  id: z.string().uuid(),
  name: z.string().min(1),
});

const parsed = MySchema.safeParse(input);
if (!parsed.success) {
  return respond(c, failure(400, 'INVALID_INPUT', 'message', parsed.error));
}
```

### Type Safety

- TypeScript with `strict: true` but `strictNullChecks: false`, `noImplicitAny: false`
- Path alias: `@/*` maps to `src/*`
- Generate Supabase types: See `src/lib/supabase/types.ts`

---

## Important Implementation Notes

### AI Analysis (Gemini)

**Prompt Strategy** (see `docs/s/daily-saju.md` for full prompts):
- Free tier: `gemini-2.5-flash` with basic Saju analysis
- Paid tier: `gemini-2.5-pro` with detailed daily fortune
- Response format: Markdown
- Implement retry logic with exponential backoff for API timeouts

**Free Trial Management**:
```typescript
// Before analysis, check remaining
const user = await supabase
  .from('users')
  .select('tests_remaining, plan')
  .eq('id', userId)
  .single();

if (user.plan === 'free' && user.tests_remaining <= 0) {
  // Redirect to /subscription
}

// After successful analysis (free users only)
if (user.plan === 'free') {
  await supabase
    .from('users')
    .update({ tests_remaining: user.tests_remaining - 1 })
    .eq('id', userId);
}
```

### Webhook Security

**Clerk Webhook** (`/api/webhooks/clerk`):
- Verify webhook signature using Clerk SDK
- Sync user.created events to Supabase `users` table
- Set initial state: `plan: 'free'`, `tests_remaining: 3`

**TossPayments Webhook** (`/api/webhooks/toss`):
- Verify signature: `crypto.createHmac('sha256', TOSS_WEBHOOK_SECRET)`
- Handle events: `success`, `failed`, `cancelled`
- Update `users` table and log to `payment_logs`

### Cron Jobs (Supabase)

**Daily Report Generation** (`/api/cron/daily-report`):
- Runs daily at midnight KST
- Queries users with `plan='paid'` and outdated `last_daily_report_date`
- Generates Gemini Pro analysis for each user
- Updates `last_daily_report_date` after success

**Recurring Billing** (`/api/cron/billing`):
- Checks `users` where `next_billing_date = today`
- Calls TossPayments billing key API
- Updates `next_billing_date` on success
- Sets `plan='suspended'` on failure

---

## UI/UX Design Guidelines

**Visual Theme**: "오방색" (Five Traditional Korean Colors)
- 청(blue), 적(red), 황(yellow), 백(white), 흑(black)
- Modern interpretation with gradients
- Mobile-first responsive design

**Page Structure**:
- `/` - Landing page with Google OAuth CTA
- `/dashboard` - User hub (plan status, history, today's fortune)
- `/new` - AI analysis request form
- `/analysis/[id]` - Result display (Markdown rendered)
- `/subscription` - Payment management

**State Indicators**:
- Always show current plan status in header/dashboard
- Clear CTA for free → paid conversion
- Loading states during AI analysis with progress messages

---

## Testing & Deployment

### Integration Testing

Reference the skill file: `.claude/skills/saju-saas-skill/SKILL.md`

**Test Scenarios**:
1. New user signup → 3 free analyses → subscribe
2. Free trial exhaustion → subscription prompt
3. Payment success → plan upgrade → daily report generation
4. Subscription cancellation → grace period → expiration
5. Payment failure → suspension → recovery

### Deployment Checklist

Before deploying to Vercel:
- [ ] All environment variables set in Vercel dashboard
- [ ] Webhook URLs configured in Clerk/TossPayments
- [ ] Supabase RLS policies enabled
- [ ] Database schema migrated (run SQL from `docs/database.md`)
- [ ] Cron jobs configured in Supabase
- [ ] Test webhook endpoints with production keys

---

## Important Documentation

Reference these files when implementing features:

| Feature | Documentation |
|---------|--------------|
| **Requirements** | `docs/requirment.md` - Full UX flow and business logic |
| **Database** | `docs/database.md` - Schema, RLS, indexes, sample queries |
| **AI Prompts** | `docs/prompts/daily-saju.md` - Gemini prompt templates |
| **External APIs** | `docs/external/*.md` - Clerk, TossPayments, Gemini integration guides |
| **Skill Reference** | `.claude/skills/saju-saas-skill/SKILL.md` - Complete development guide |

---

## Common Gotchas

1. **Clerk userId vs Supabase auth.uid()**
   - Clerk uses TEXT user IDs, Supabase auth uses UUID
   - Always use Clerk userId for `users.id` column
   - RLS policies use `service_role` check, not `auth.uid()`

2. **Service Role Key Usage**
   - Client should NEVER access Supabase directly
   - All DB operations go through API routes with Service Role Key
   - Middleware uses anon key only for auth state check

3. **TypeScript Configuration**
   - `strictNullChecks: false` - handle nulls carefully
   - `noImplicitAny: false` - prefer explicit types when possible
   - Build may pass with ESLint warnings (set to ignore during builds)

4. **Webhook Testing**
   - Use webhook.site or ngrok for local testing
   - Vercel deployment must be HTTPS for webhooks
   - Check webhook logs in Clerk/Toss dashboards

5. **Gemini API Timeouts**
   - Implement retry with exponential backoff
   - Set Vercel function timeout to 60s
   - Use streaming for Pro tier if responses are slow

---

## Development Workflow

1. **Adding a New Feature**:
   - Create folder: `src/features/{feature-name}/`
   - Define backend routes in `backend/route.ts`
   - Register routes in `src/backend/hono/app.ts`
   - Create React components in `components/`
   - Add React Query hooks in `hooks/`

2. **Database Changes**:
   - Update schema in `docs/database.md`
   - Run SQL migration in Supabase SQL Editor
   - Regenerate types if needed

3. **Adding API Endpoints**:
   - All endpoints route through Hono app
   - Use middleware for common operations (auth, logging)
   - Return standardized responses using `respond()` helper

4. **Testing Locally**:
   ```bash
   npm run dev
   # Visit http://localhost:3000
   # Test Clerk auth flow
   # Test Supabase queries via API routes
   ```

---

## Quick Reference: File Locations

```
src/
├── app/
│   ├── api/[[...hono]]/route.ts    # Single API entry point
│   ├── (protected)/                # Auth-required pages
│   │   └── dashboard/page.tsx
│   ├── login/page.tsx
│   └── layout.tsx                  # Root layout
├── backend/
│   ├── hono/app.ts                 # Hono app setup
│   ├── middleware/                 # Shared middleware
│   └── supabase/client.ts          # Backend Supabase client
├── features/
│   └── {feature}/
│       ├── backend/                # API routes, services
│       ├── components/             # UI components
│       └── hooks/                  # React hooks
├── lib/
│   └── supabase/                   # Supabase clients
├── constants/
│   ├── env.ts                      # Environment variables
│   └── auth.ts                     # Auth path configuration
└── middleware.ts                   # Next.js middleware (route protection)

docs/
├── requirment.md                   # Full requirements spec
├── database.md                     # Database schema
├── prompts/daily-saju.md           # AI prompt templates
└── external/                       # Integration guides
```
