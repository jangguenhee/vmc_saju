---
name: vcm-saju-requirements
title: "365일 사주 – 구독형 AI 운세 SaaS 요구사항 명세서"
description: >
  Gemini AI 기반 사주팔자 분석을 중심으로 한 개인 맞춤형 운세 SaaS.
  사용자는 Google 로그인 후 무료 체험(3회)을 통해 서비스를 경험하고,
  월 3,650원 구독을 통해 매일 ‘오늘의 사주’ 리포트를 제공받는다.
author: "moguni"
version: "1.0.0"
last_updated: "2025-10-25"
tags:
  - AI
  - SaaS
  - TossPayments
  - Clerk
  - Supabase
  - Gemini
  - Requirement
---

# 365일 사주 - 구독형 AI 운세 SaaS 요구사항 명세서

## 1. 서비스 개요

이 서비스는 **AI 사주팔자 분석을 구독형 SaaS 형태로 제공**하는 개인 맞춤형 운세 분석 플랫폼이다.  
사용자는 **Google 계정으로 간편 로그인** 후, **무료 체험 3회**를 통해 실제 AI 사주 리포트를 체험할 수 있다.  
이후 자신의 **“오늘의 사주”**를 매일 받아보기 위해 **365일 사주(월 구독 3,650원)**로 전환하도록 설계되어 있다.  

즉, 서비스의 핵심 흐름은  
**무료 체험 → 가치 체감 → 구독 전환 → 일일 사주 리포트 제공**으로 이어진다.  

이 서비스의 목적은 단순한 사주풀이가 아니라,  
**Gemini AI 기반의 정교한 일간(日干)·일주(⽇柱) 분석을 통해 사용자의 하루를 예측·조언하는 ‘AI 운세 코치’ 경험을 제공하는 것**이다.  

- **AI 분석 엔진**: Google Gemini API (`gemini-2.5-flash / pro`)  
- **결제 시스템**: TossPayments SDK (정기 구독 / 결제 해지 / 재결제 관리)  
- **데이터 및 자동화**: Supabase (사용자·분석·결제 관리 및 cron 트리거)  
- **배포 및 웹훅 환경**: Vercel (Clerk / Toss / Supabase Webhook 정상 연동 필수)  


---

## 2. 사용자 경험 흐름 요약 (UX Flow)

### ① 랜딩 페이지 (비로그인 상태)

- 사용자가 `https://vcm-saju.vercel.app` 에 접속하면,  
  **오방색천(청·적·황·백·흑)을 시각적 모티브로 한 배경 애니메이션이 적용된 랜딩 화면**이 표시된다.  
  - 구현 의도: 무속적 상징(오방색)을 현대적 그래픽으로 표현하여 신비감 + 기술적 감각을 전달한다.  
  - CSS Gradient 또는 SVG Layer Animation으로 구현 가능.  
- 헤드라인: **“당신의 사주, AI가 분석합니다.”**  
- 서브텍스트: **“당신의 전 생애에 걸친 일간(日干) 일주를 매일 AI로 분석합니다.”**  
  - 이 한 문장으로 사용자는 “이 서비스는 단순한 운세풀이가 아니라, AI가 매일 갱신하는 개인 리포트형 SaaS”임을 즉시 인식한다.  

#### 주요 CTA 구성
- **“무료로 시작하기”** → Clerk의 Google 로그인으로 이동  
- **“오늘의 사주 보기”** → 구독 안내 섹션으로 스크롤 이동  

#### 내비게이션 및 시각 구조
- 왼쪽 상단: "365일 사주" 서비스 명칭
- 우측 상단: “시작하기” 메뉴가 배치
- 중앙:   홈  | 서비스 | 복채 | FAQ
  하단에는 서비스 핵심 가치(3단 구성)가 카드 형태로 노출된다:
  1. **AI 분석의 정밀함** — 풍부한 AI 학습데이터 기반 천간·지지 정밀 계산  
  2. **맞춤형 리포트** — 매일 새롭게 업데이트되는 개인 운세 리포트  
  3. **간편한 구독관리** — 365일 지속 가능한 자동 결제·해지 시스템  

#### UX 설계 의도
- 첫 10초 내에 “**AI 기반 사주 구독 서비스**이며, **무료 체험이 가능하다**”는 점을 인식하게 만든다.  
- 불필요한 정보 없이 단일 행동(“무료로 시작하기”)으로 전환을 유도한다.  
- **감성적 신뢰감 + 기술적 전문성**을 동시에 전달하는 디자인 톤을 유지한다.



### ② 로그인 & 가입 (Clerk SDK)

- **“무료로 시작하기” 버튼 클릭 → Clerk SDK의 Google OAuth UI로 이동**  
  - 로그인/회원가입은 Clerk에서 제공하는 기본 UI 컴포넌트를 그대로 사용  
  - 인증 과정은 페이지 리로드 없이 SPA 방식으로 처리되어, 자연스러운 전환 경험 제공  

---

#### 🧭 최초 로그인 처리 흐름

1. **Clerk 인증 완료 → `session` 생성**
2. **Supabase `users` 테이블 자동 등록**
   ```ts
   {
     id: clerk_user_id,
     email: user_email,
     plan: "free",
     tests_remaining: 3,  // 무료 체험 3회 제공
     created_at: now()
   }

	3.	등록 완료 후 /dashboard로 자동 리다이렉트

⸻

🎨 UI 요소
	•	헤더 우측: Clerk의 <UserButton /> 고정 표시 (로그인/로그아웃 관리)
	•	로그인 후 상단 배너:
	•	무료 체험 중 (남은 3회)
	•	또는 365일 운세 구독 중
→ 현재 상태를 직관적으로 인식 가능
	•	모바일에서도 동일한 위치와 흐름을 유지하여 일관된 UX 제공

⸻

💡 UX 설계 의도

|항목 |설명|
|--------|---------|
|즉각적 피드백 |	로그인 완료 후 별도의 새로고침 없이 /dashboard로 |전환 → 사용자 연결감 유지 |
 |상태 명확성	|배너를 통해 무료 체험 잔여 횟수와 구독 상태를 실시간 인식|
|구독 전환 유도	|무료 체험 중에도 상단에 “오늘의 사주 받기 → 365일 운세 시작하기” 안내 배너 노출|
 |UI 일관성 |	Clerk SDK 기본 컴포넌트를 활용하여 인증 UX 단순화 및 유지보수 최소화 | 
 |접근성 강화 |	모바일 환경에서도 Google OAuth 팝업 흐름이 자연스럽게 작동하도록 구성 |


⸻


## ③ 대시보드 (`/dashboard`)


**역할**: **현재 상태·분석 히스토리·구독 상태·오늘의 사주 접근**을 한눈에 보여주는 허브이다.  
사용자가 “AI 운세 코치”와 **일상적으로 연결**되어 있다고 느끼도록 설계.


---

### 구성

1) **상단 상태 카드**
- 플랜 상태:
  - **무료 체험 중 (남은 3회)** 또는 **365일 운세 구독 중**
- 다음 결제일/남은 구독일 표시
- CTA 버튼:
  - **무료 사용자** → **“365일 운세 시작하기 (월 3,650원)”**
  - **구독 사용자** → **“운세 구독 관리”**
- 구독 사용자에게는 **“오늘의 사주 받기”** 버튼 활성(하루 1회)

2) **분석 히스토리(카드형)**
- 항목: 생성일, 주요 키워드(성격/행운 포인트 등), **상세보기**
- 정렬: 최신순
- 비어있을 때:
  - “아직 분석 내역이 없습니다.”
  - **“오늘의 사주 받기”**  버튼 → `/new`

3.  **오늘의 사주(구독자)**
   - 로그인 시점 기준으로 Gemini API가 생성한 최신 일일 리포트를 표시한다.  
   - 요약 카드에는 “오늘의 키워드”, “행운 포인트”, “AI 조언” 등이 포함된다.  
   - 클릭 시 `/analysis/[id]` 상세 페이지로 이동.  

---

#### 🧭 UX 설계 의도

- **핵심 목표:**  
  사용자가 “내 사주 생활이 이곳에서 관리되고 있다”는 느낌을 받을 것.  
  즉, **AI 운세 코치**라는 지속적 관계감을 부여하는 허브 역할을 수행한다.

- **무료 사용자는**  
  잔여 체험과 함께 **“365일 운세 시작하기”**로 자연 유도

- **Pro 사용자는**  
  “오늘의 사주” 위젯과 분석 내역 카드가 결합되어  
  매일 방문하도록 동기부여한다.  

- **시각적 톤앤매너:**  
  -  카드형 요약   -> 상세 보기 표로 넘어가는  구조
  - 하루 운세 리포트를 ‘데이터가 살아있는 영역’처럼 보여주는 미세한 애니메이션  
  -  **감정적 지속성**: 하루 변화/조언을 루틴처럼 체감
  - 분석 결과가 없을 때도 ‘빈 페이지 불안감’을 줄이는 유도형 메시지 ' 


---

### ④ 오늘의 사주  (`/new`)

**목적:**  
사용자가 자신의 생년월일 정보를 입력해 **AI에게 오늘의 사주 분석을 요청하는 핵심 페이지**이다.  
이 구간은 사용자가 처음으로 “AI 사주 코치”와 상호작용하는 단계로,  
분석 과정의 신뢰감·몰입감·서비스 품질을 체감하도록 설계된다.

---

#### 🧩 입력 폼 구성

- 필드:
  - **이름 (필수)**  
  - **생년월일 (필수)** – YYYY-MM-DD 포맷  
  - **출생시간 (선택)** – “모름” 옵션 포함  
  - **성별 (필수)** – 남성 / 여성  
- 제출 버튼: **“AI 사주 분석 시작하기”**
  - 클릭 시 모든 필드 유효성 검사  
  - 유효하지 않을 경우 실시간 인라인 피드백 표시  
  - 입력이 완료되어야만 활성화 (로딩 중엔 비활성화 상태 유지)

---

#### ⚙️ 처리 흐름 (기능 동작 순서)

1. **입력 제출 및 검증**
  - `onSubmit` 시 Supabase `users.tests_remaining` 확인  
- **무료 사용자**
  - 남은 횟수 > 0 → 진행(체험 1회 차감)
  - 남은 횟수 = 0 → **안내 모달** “무료 체험이 모두 소진되었습니다” → `/subscription` 유도
- **구독 사용자(365일 운세)**
  - **하루 1회** 당일 리포트 생성(이미 생성했다면 리마인드 안내 + 바로 이동)

2. **AI 분석 요청**
- 무료: `gemini-2.5-flash`
- 구독: `gemini-2.5-pro`
- 프롬프트 입력:
  ```ts
  { name, birthDate, birthTime, gender }
     ```
 - `generateSajuPrompt(input)` 함수를 통해 사주 분석용 시스템 프롬프트 생성 후 API 요청  

3. **로딩 및 진행 시각화**
   - 중앙에 AI 애니메이션 + 진행 메시지 순차 노출:
     - “천간과 지지를 해석하는 중입니다…”  
     - “오행의 균형을 분석하고 있습니다…”  
     - “오늘의 운세를 정리하는 중입니다…”  
   - 가상의 **진행률 바(Progress Bar)** 로 0→100% 전환  
     → 사용자가 “AI가 실제로 계산 중”이라는 감각을 받게 설계  

4. **결과 수신 및 저장**
   - Gemini 응답 완료 시 Supabase `analysis` 테이블에 저장:
     ```ts
     {
        user_id,
        input: { name, birthDate, birthTime, gender },
        output_markdown,
        created_at: now(),
        type: "daily" | "free"  // 용도 식별
     }
     ```
   - 저장이 완료되면 `/analysis/[id]` 페이지로 자동 이동  

---

#### 💡 예외 및 복구 처리

- **API 오류 / 타임아웃**
  - 안내문구: “AI 분석 중 오류가 발생했습니다. 무료 체험 횟수를 복구했습니다.”  
  - `tests_remaining` +1 복구  
  - “다시 분석하기” 버튼 활성화  

- **응답이 긴 경우**
  - 마크다운 렌더링 시 단락 간 `margin-top: 1.5rem` 확보  
  - “요약 보기 / 전체 보기” 토글 지원  

- **네트워크 오류 / 새로고침**
    - 로컬스토리지에 입력값 자동 저장  
    - 복귀 시 “이전 입력을 복원하시겠습니까?” 토스트 안내  


#### 🧭 UX 설계 의도

| 목표 | 구현 포인트 |
|------|--------------|
| **AI 실재감 강화** | 로딩 중 단순 스피너 대신 ‘분석 서사’형 메시지 제공 |
| **서비스 신뢰 확보** | 오류 발생 시 체험권 복구로 ‘공정성’ 체감 |
| **결과 가독성** | Markdown 단락 구조 + 여백 + 토글 기능으로 긴 텍스트 완화 |
| **연속성 유지** | 입력값 자동 복원 → 사용자의 맥락 손실 방지 |


---

#### 🎨 UI 톤앤매너 제안

- **배경:**  
  은은한 **오방색 그라데이션(황→청→백→적→흑)**을 적용하여,  
  한국 전통의 색동저고리에서 모티브를 얻은 현대적으로 재해석한 비주얼 구현.  그라데이션은 10초 주기로 자연스럽게 흐름. 
  → 서비스의 상징성과 기술적 세련미를 동시에 전달.  

- **분석 중 상태:**  
  중앙에 **AI 코어 형태의 미세한 회전 애니메이션**을 표시하여  
  “AI가 실제로 분석 중이다”는 인상을 강화.  

- **버튼 스타일:**  
  - Free 사용자 → 기본 중립 톤  
  - 365일 운세 구독자 → **골드 하이라이트 버튼**으로 차별화  

- **분석 완료 시:**  
  “✨ 분석이 완료되었습니다.” 메시지 표시 후  
  자동으로 `/analysis/[id]` 페이지로 자연스럽게 이동.  

➡ **UI 설계 목적:**  
AI 분석 과정을 감각적으로 표현하여 사용자 몰입도를 높이고,  
Free → 구독 사용자로의 여정을 시각적으로 명확히 구분한다.

---

**→ 핵심 메시지:**  
“이곳은 당신의 하루를 해석하는 AI 코치의 공간이다.”  
사용자는 단순히 데이터를 입력하는 것이 아니라,  
**AI가 나를 이해하고 오늘의 길흉을 해석해주는 경험**을 얻는다.

---

### ⑤ 분석 상세보기 (`/analysis/[id]`)

**목적:**  
AI가 생성한 사주 분석 결과를 사용자가 **가독성 높게 열람하고**,  
필요 시 **다시 분석·공유·구독 전환**으로 이어질 수 있도록 설계된 결과 페이지이다.  
이 페이지는 “AI 운세 코치”가 전달하는 하루 리포트를 완성도 있게 경험하는 공간이다.

---

#### 📊 구조 개요

| 구역 | 설명 |
|------|------|
| **상단 정보 패널** | 사용자 입력 요약 (이름, 생년월일, 출생시간, 성별, 분석일) + 구독 상태 배너 |
| **본문** | Gemini AI 분석 결과 (Markdown 렌더링)<br>→ 섹션: 천간/지지 해석, 오행 분석, 대운/세운, 오늘의 조언 |
| **하단 액션 영역** | “다시 분석하기”(`/new`), “목록으로 돌아가기”(`/dashboard`), **“공유하기” 버튼** 포함 |

---

#### 💎 구독 상태별 기능 차이

##### 🆓 **무료 체험 사용자**
- 상단 배너:  
  > **무료 체험 중 – 남은 분석 2회**  
  > “AI가 당신의 하루를 해석합니다. 365일 운세 구독으로 매일 받아보세요 (월 3,650원)”  
- 본문: 주요 요약 섹션만 표시 (세운·대운 해석은 비활성화 영역으로 블러 처리)  
- 하단 버튼:
  - **다시 분석하기** → `/new` (남은 횟수 차감)  
  - **365일 운세 구독하기** → `/subscription`  
  - **공유하기** → SNS/카카오톡/링크 복사 모달  
    → 공유 시 “무료 사주 3회 체험 링크”가 자동 포함됨  

##### 🌕 **365일 운세 구독자**
- 상단 배너:  
  > **365일 운세 구독 중 – 오늘의 리포트**  
  > “다음 분석 가능일: 내일 00:00 이후”  
- 본문: 모든 분석 섹션 전체 공개  
- 하단 버튼:
  - **내일의 사주 알림 설정** (토글)  
  - **공유하기** → SNS/링크 공유 + “AI 사주 리포트 - 오늘의 운세 요약” 자동 생성  
  - **목록으로 돌아가기**(`/dashboard`)  
  - **다시 분석하기** 비활성화 (툴팁: “하루 1회 분석 제한”)  

---

#### 🔗 공유 기능 세부 명세

| 항목 | 설명 |
|------|------|
| **공유 버튼 위치** | 본문 하단, “다시 분석하기” 오른쪽 |
| **공유 대상** | 카카오톡, 트위터, 페이스북, X(선택), 클립보드 링크 복사 |
| **공유 내용 구성** | 제목: “AI 사주 코치가 알려주는 오늘의 운세 🌞”<br>요약: Gemini 결과 중 ‘오늘의 조언’ 2줄 추출<br>링크: `https://vcm-saju.vercel.app/share/[analysis_id]` |
| **공유 링크 처리** | `/share/[analysis_id]` 페이지는 공개용 요약 뷰 (민감 정보 제외) |
| **SNS 이미지(OG 태그)** | 오방색 그라데이션 배경 + 서비스 로고 + “오늘의 사주 리포트” 문구 포함된 카드형 이미지 생성 (서버에서 OG Image API로 동적 생성) |

---

#### 🎨 UI 톤앤매너 제안

- **색상 구분:**  
  - 무료 사용자: 은은한 회색·청색 계열  
  - 구독자: 골드 포인트 버튼  
- **버튼 구성:**  
  `[← 목록으로] [다시 분석하기] [공유하기]`  
  (모바일에서는 FAB 형태로 2단 구성)
- **스크롤 시 고정 요소:**  
  상단 요약 정보는 sticky, 하단 버튼 바는 고정  
- **본문 스타일:**  
  Markdown 기반, 제목-본문 간 여백 1.6rem, 링크·인용문 하이라이트  

---

#### 🧭 UX 설계 의도

| 목표 | 구현 포인트 |
|------|--------------|
| **결과 공유로 신규 유입 유도** | 공유 링크에 무료 체험 CTA 자동 포함 |
| **AI 분석 신뢰감 강화** | Markdown 구조화 + 시각적으로 정돈된 리포트 |
| **무료→구독 전환 자연화** | 세운/대운 섹션 비활성화 + “365일 운세 시작하기” 유도 |
| **일상 루틴화** | 구독자는 “오늘의 리포트” → 내일 알림 토글 UX 제공 |

#### 예시 버튼 구성

**[← 목록으로]   [다시 분석하기]   [공유하기 📤]**

- (무료 사용자)
→ 클릭 시 무료 체험 홍보 링크 포함 공유
- (구독 사용자)
→ 클릭 시 “AI 사주 리포트 - 오늘의 운세” 카드형 미리보기 공유

    ➡ **요약:**  
    `/analysis/[id]`는 **AI 리포트 열람 + 구독 전환 + 공유 확산**의 삼중 역할을 수행한다.  
    공유 기능은 무료 체험 확산과 자연스러운 구독 마케팅의 핵심 루프이며,  
    “오늘의 사주를 공유하는 즐거움” 자체가 서비스 성장 동력으로 작용한다.
---



### ⑥ 구독 관리 (`/subscription`)

**목적:**  
사용자가 자신의 **현재 구독 상태를 명확히 확인하고**,  
**365일 운세(월 3,650원)** 구독 결제를 생성·관리·해지할 수 있는 페이지이다.  
이 영역은 **결제 시스템(TossPayments SDK)** 및 **정기 결제 자동화(Supabase cron)**의 핵심 허브로 작동한다.

---

#### 📋 기본 구성 요소

| 구역 | 설명 |
|------|------|
| **상단 정보 카드** | 현재 플랜, 남은 분석 횟수, 다음 결제일, 구독 상태 표시 |
| **결제 관리 영역** | TossPayments SDK 연동 버튼으로 구독 생성·해지·재결제 가능 |
| **정기결제 안내** | 매월 1회 자동 결제(3,650원), 해지 시 다음 결제일까지 유지 |
| **하단 알림 영역** | 결제 실패 / 만료 / 해지 완료 시 실시간 피드백 표시 |

---

#### 💎 상태별 표시 및 동작

##### 🆓 **무료 체험 사용자**
- 상단 카드:
  > **현재 플랜: 무료 체험 (남은 분석 2회)**  
  > “365일 AI 운세 구독으로 매일의 리포트를 받아보세요 (월 3,650원)”  
- CTA 버튼:  
  - **“365일 운세 시작하기 (₩3,650/월)”** → TossPayments 결제창 호출  
- 결제 완료 시:
  - Supabase `users` 테이블 업데이트:
    ```ts
    plan: "paid",
    next_billing_date: addMonths(now(), 1),
    tests_remaining: 365,
    billing_key: {TOSS_KEY}
    ```
  - 확인 후 `/dashboard`로 자동 리다이렉트  

##### 🌕 **365일 운세 구독자**
- 상단 카드:
  > **현재 플랜: 365일 운세 (월 ₩3,650)**  
  > “다음 결제일: 2025-11-25”  
  > “잔여 분석일: 오늘 포함 X일 남음”
- 버튼 구성:
  - **“구독 해지하기”** → TossPayments 구독 해지 API 호출  
  - **“결제 이력 보기”** → `/subscription/history` (선택 구현)
  - **“재결제 시도”** → TossPayments billing_key 기반 재청구  
- 해지 시:
  - `billing_key` 즉시 삭제  
  - `plan` → `"cancelled"`  
  - 다음 결제일까지 기존 혜택 유지  
  - 만료일 도래 시 `plan: "free"`, `tests_remaining: 0`으로 자동 전환  

---

#### ⚙️ 자동 결제 처리 (요약)

- 정기결제는 **TossPayments BillingKey 기반의 자동 청구 구조**로 설계한다.  
- 결제·해지·재결제 이벤트는 Toss Webhook을 통해 Supabase로 동기화되며,  
  Supabase의 Cron은 **백업(fail-safe)** 역할로 사용된다.  
- 상세 API 호출 구조 및 Webhook 이벤트 매핑은 `/docs/prompt/external.md`에 기술한다.

---

#### 💡 예외 및 에러 처리

| 상황 | 처리 로직 |
|------|------------|
| **결제 실패 (카드 한도 초과 등)** | 사용자에게 **앱 내 배너 + 이메일 알림** 제공 → “결제 재시도” 버튼 활성화 |
| **Webhook 미수신 / 결제 오류** | Supabase 로그 테이블(`payment_logs`)에 기록 후 관리자 확인 가능 |
| **구독 해지 중 새 결제 발생** | Cron 실행 전 해지 요청일 비교, 중복 결제 방지 |
| **Billing Key 누락** | 결제 재시도 버튼 클릭 시 Toss SDK에서 재발급 요청 |

---

#### 🎨 UI 톤앤매너 제안

- **배경 톤:** 밝은 중립 베이지 + 오방색 포인트 라인 (서비스 전체 통일감 유지)  
- **버튼 스타일:**  
  - 활성(결제): 골드 하이라이트  
  - 해지: 붉은 라인형 버튼  
- **결제 상태 알림:**  
  - 성공 → “✅ 결제가 완료되었습니다.”  
  - 실패 → “⚠️ 결제 실패 – 카드 상태를 확인해주세요.”  
  - 해지 → “🧾 구독이 해지되었습니다. 다음 결제일까지 혜택이 유지됩니다.”  

---

#### 🧭 UX 설계 의도

| 목표 | 구현 포인트 |
|------|--------------|
| **직관적인 결제 관리** | Toss SDK를 통한 구독/해지/재결제 전 과정을 한 화면에서 처리 |
| **안정적인 자동화** | Supabase cron 기반 결제일 자동 탐색 및 결제 수행 |
| **사용자 신뢰 확보** | 해지 즉시 billing_key 제거 및 만료일까지 서비스 유지 정책 |
| **명확한 피드백** | 모든 결제/해지 이벤트에 대해 실시간 Toast 피드백 및 이메일 알림 제공 |

---

#### 예시 UI 플로우

[상단 카드]
현재 플랜: 무료 체험 (남은 2회)
365일 운세 구독으로 매일의 AI 리포트를 받아보세요.
[365일 운세 시작하기 💫]

→ 결제 완료 후

현재 플랜: 365일 운세 (월 ₩3,650)
다음 결제일: 2025-00-00
[구독 해지하기] [결제 이력 보기]

[결제 실패 시 알림]
⚠️ 결제 실패 – 카드 정보를 확인하고 재결제해주세요.
[재결제 시도]

---

➡ **요약:**  
`/subscription` 페이지는 **무료 체험 → 유료 구독 전환 → 자동 결제 관리**를 담당하는 핵심 허브이다.  
결제/해지/재결제/알림의 모든 단계가 TossPayments SDK와 Supabase cron을 통해 자동화되어야 하며,  
사용자는 언제든 자신의 결제 상태를 **명확히 이해하고 제어할 수 있어야 한다.**


---

## 3. 구독 정책 요약

| 항목 | **무료 체험 (Free Trial)** | **365일 운세 (월 ₩3,650)** |
|------|----------------------------|-----------------------------|
| **분석 가능 횟수** | 총 3회 제공 (1회당 1일 리포트 생성 가능) | 연중 365회 (하루 1회 자동 생성) |
| **AI 모델** | `gemini-2.5-flash` (경량 분석 모델) | `gemini-2.5-pro` (정밀 분석 모델) |
| **결제 방식** | 결제 없음 (Clerk 가입 시 자동 등록) | 월 ₩3,650 정기결제 (TossPayments BillingKey) |
| **자동 결제** | 해당 없음 | 매월 동일일 자동 청구 (Webhook + Supabase cron) |
| **취소 정책** | 해당 없음 | 결제일 전 해지 가능, 해지 후 다음 결제일까지 유지 |
| **재구독 정책** | 없음 | 해지 시 BillingKey 삭제 → 재결제 시 재발급 필요 |
| **분석 제한 정책** | 무료 체험 3회 초과 시 `/subscription` 안내 | 하루 1회 분석 제한 (00:00 이후 갱신) |
| **AI 모델 전환** | 불가 | 자동 Pro 모델(`gemini-2.5-pro`) 사용 |

---

### 💡 설계 의도

- **무료 체험 (Free Trial)**  
  - 사용자가 AI 사주 분석 품질을 직접 체감할 수 있는 진입 단계  
  - 3회 분석 후, 자연스럽게 “AI의 정밀함과 일일 리포트 가치”를 인식하게 설계  

- **365일 운세 (월 ₩3,650)**  
  - 하루 ₩120 수준의 “AI 운세 코치” 구독 개념  
  - 매일 자동으로 오늘의 사주 리포트를 생성·제공  
  - 결제일 기준 1개월 단위로 자동 갱신  

- **해지 정책**  
  - 구독 해지 즉시 BillingKey 삭제  
  - 해지 후에도 결제 주기 내 남은 기간 동안 서비스 이용 가능  

➡ 본 정책은 **무료 체험 → 구독 전환 → 매일의 AI 운세 제공**이라는 서비스 여정을  
사용자 입장에서 명확하게 이해할 수 있도록 구조화하였다.

---

## 4. 기술 명세 요약

이 서비스는 `Clerk`, `Supabase`, `TossPayments`, `Gemini API`, `Vercel` 간의 유기적 연동을 기반으로 한 **AI 운세 분석 SaaS**이다.  
요구사항 문서에서는 전체 아키텍처의 개요만을 다루며,  
세부 API 명세와 데이터 모델은 `/docs/spec.md` 및 `/docs/prompt/external.md`에서 정의한다.

---

### 기술 스택 구성

| 영역 | 사용 기술 | 핵심 역할 |
|------|------------|------------|
| 인증 | `Clerk SDK` | Google OAuth 기반 로그인/가입 제공. Webhook을 통해 `Supabase.users` 테이블과 동기화. |
| 데이터베이스 및 스케줄링 | `Supabase` | PostgreSQL 기반. `users`, `analysis`, `payments` 테이블 관리. `pg_cron`을 이용한 정기결제 점검 수행. |
| 결제 | `TossPayments SDK` | 월 ₩3,650 구독 결제. BillingKey 기반 자동 청구·해지·재결제 관리. Webhook 이벤트(`success`, `failed`, `cancelled`) 연동. |
| AI 분석 | `Gemini API` | `gemini-2.5-flash`(무료) / `gemini-2.5-pro`(유료) 모델 사용. 사용자 입력을 프롬프트로 변환해 Markdown 결과 생성. |
| 배포 | `Vercel` | Next.js 기반 SaaS 배포 환경. HTTPS 지원 및 Webhook 수신. 환경 변수(`.env.local`)로 시크릿 관리. |
| 자동화 백업 | `Supabase Cron + API Route` | Webhook 실패 시 일일 결제 점검 및 보조 결제 수행(`/api/payments/cron`). |
| 버전 관리 | `GitHub + Vercel` | PR 생성 시 Preview 배포 자동화. 문서(`requirement.md`, `spec.md`) 동시 버전 관리. |

---

### 설계 원칙 요약

1. **단일 체계 구조**  
   각 기능(`Clerk`, `TossPayments`, `Gemini`)은 독립적으로 작동하되 Webhook으로 유기적으로 연결한다.

2. **확장성과 유지보수성 확보**  
   주요 로직은 `Serverless API Route`(`/api/...`)로 분리해 재사용 가능하도록 구성한다.

3. **보안 중심 설계**  
   `BillingKey`, `API Key` 등 민감정보는 환경 변수로만 관리하고, Webhook 요청은 서명 검증을 통해 인증한다.

4. **장애 복원력 확보**  
   Toss Webhook 실패 시 Supabase `cron`이 보조 결제를 수행하는 fail-safe 구조를 유지한다.

---

> **참고:**  
> 본 기술 명세는 2025년 10월 25일 기준으로 검증된 아키텍처 개요이며,  
> 모든 기술 스택은 상호 호환 가능하고 프로덕션 수준에서 안정적으로 운영 가능함을 확인하였다.

---

---

## 5. 테스트 및 검증 시나리오

### ✅ 기능 검증 흐름

1. **신규 가입자 시나리오**  
   - Clerk 인증 후 Supabase `users` 테이블 자동 생성 여부 확인  
   - `tests_remaining = 3`으로 초기화 확인  

2. **무료 체험 한도 확인**  
   - 3회 분석 요청까지 정상 작동  
   - 4번째 요청 시 “무료 체험이 모두 소진되었습니다. 365일 운세를 시작해보세요.” 모달 노출 확인  
   - `/subscription` 페이지로 자연스럽게 이동되는지 검증  

3. **365일 운세 구독 시나리오**  
   - TossPayments 결제 완료 시 `plan: "paid"`, `tests_remaining: 365`로 갱신  
   - `next_billing_date`가 1개월 뒤로 설정되는지 확인  
   - `/dashboard`에 “365일 운세 구독 중” 배너 정상 표시  

4. **해지 및 만료 처리 확인**  
   - 해지 시 `plan: "cancelled"`, `billing_key` 즉시 삭제  
   - 다음 결제일까지 혜택 유지 후 자동 `free` 전환  
   - Webhook 및 Cron 기반 만료 동작 검증  

5. **정기결제 자동화 점검 (Supabase Cron)**  
   - `next_billing_date = today` 조건 충족 시 자동 결제 API 호출 확인  
   - 성공 시 결제 로그(`payment_logs`) 기록 및 `next_billing_date` 갱신  
   - 실패 시 사용자 알림 및 상태 `suspended`로 변경  

6. **UI/UX 반응형 검증**  
   - 모바일, 태블릿, 데스크톱 환경에서 레이아웃 깨짐 없는지 확인  
   - 분석 결과 마크다운 렌더링 및 버튼 클릭 영역의 일관성 테스트  

---

### 🧪 테스트 환경

| 항목 | 설정 |
|------|------|
| **테스트 서버** | Vercel Preview 배포 URL |
| **테스트 계정** | Clerk 테스트 사용자 (Google OAuth) |
| **결제 모드** | TossPayments 테스트 키 |
| **AI 호출** | Gemini Flash 모델 (무료 버전) |
| **DB** | Supabase 개발 인스턴스 (cron 활성화 상태) |

---

### 🎯 검증 목표

- 전환 흐름(**무료 → 구독**)이 매끄럽게 작동해야 함  
- 구독 상태(`free`, `paid`, `cancelled`)가 항상 일관성 있게 반영되어야 함  
- 결제 실패·API 오류 상황에서도 **데이터 무결성**과 **fail-safe 복구**가 유지되어야 함  


---

## 6. 평가 기준

| 평가 항목 | 평가 내용 |
|------------|------------|
| **SDK 연동 안정성** | `Clerk`, `Supabase`, `TossPayments`, `Gemini` 간 연동 오류가 없으며 Webhook 및 API 응답이 정상적으로 동작해야 함. |
| **문서 명확성** | `requirement.md`가 기능·흐름·기술 요구사항을 명확히 기술하여 실제 개발에 바로 적용 가능한 수준이어야 함. |
| **배포 및 운영 안정성** | `Vercel` 환경에서 배포된 이후에도 Webhook, Cron, API 라우트가 정상 작동해야 하며, 예외 상황에서 fail-safe 로직이 유효해야 함. |
| **UX 일관성** | 로그인 → 분석 → 구독 → 유지 흐름이 페이지 전환 없이 자연스럽게 이어지며, 사용자 상태(무료/유료)가 항상 명확히 표시되어야 함. |
| **보안 준수 여부** | BillingKey, API Key 등 민감정보를 환경 변수로 안전하게 관리하고, Webhook 요청에 대한 서명 검증이 구현되어야 함. |
| **(가산점) Agent 관리** | `Skill.md` 및 프롬프트 문서가 Git 버전 관리 하에 명시되어 있을 경우, 문서 관리 체계 평가 시 가산점 부여. |

---

## 7. 결론

본 문서는 **‘365일 사주’ AI SaaS 서비스의 사용자 중심 설계 및 기술 요구사항을 명확히 정의하기 위한 기준 문서**이다.  
목표는 다음과 같다:

- **가입 → 분석 → 구독 → 유지** 전 과정이 매끄럽고 직관적으로 작동할 것  
- **SDK 간 연동 안정성**, **결제 자동화 신뢰성**, **UX 일관성**을 모두 확보할 것  
- 서비스 장애 발생 시에도 **데이터 손실 없이 복구 가능한 fail-safe 구조**를 유지할 것  

요구사항 준수 여부는 실제 배포 환경에서의 기능 작동 결과로 평가하며,  
**사용자 경험이 본 문서에 기술된 흐름과 일치할 경우 ‘기능 구현 완료’로 간주한다.**